Load game ratings and data manipulation
```{r}
library(gsheet)
library(tidyverse)
library(readxl)
library(lubridate)
library(geosphere)
#library(data.table)

#https://projects.fivethirtyeight.com/mlb-api/mlb_elo.csv
#https://projects.fivethirtyeight.com/mlb-api/mlb_elo_latest.csv
#/Users/anthonybrennan/Downloads/mlb_elo.csv
raw <- read.csv("https://projects.fivethirtyeight.com/mlb-api/mlb_elo.csv")

# Win streak/losing streak, home/away performance

mlb <- data.frame(game.id = seq(1,nrow(raw)),
                  date = as.Date(raw$date), month = "", day = "",
                  game.num = 1, season = raw$season, playoff = raw$playoff,
                  away.team = raw$team2, home.team = raw$team1,
                  away.div = "", home.div = "", div.match = 0,
                  away.game.num = as.integer(NA), home.game.num = as.integer(NA),
                  away.rate = raw$rating2_pre, home.rate = raw$rating1_pre,
                  away.pit.rate = raw$pitcher2_rgs, home.pit.rate = raw$pitcher1_rgs,
                  away.pit.adj = raw$pitcher2_adj, home.pit.adj = raw$pitcher1_adj,
                  away.pitcher = raw$pitcher2, home.pitcher = raw$pitcher1,
                  away.win = raw$rating_prob2, home.win = raw$rating_prob1,
                  doublehead = as.integer(NA), stadium = as.character(NA),
                  away.travel = as.integer(NA), home.travel = as.integer(NA),
                  away.yest = as.integer(NA), home.yest = as.integer(NA),
                  away.final = raw$score2, home.final = raw$score1,
                  away.60 = as.integer(NA), home.60 = as.integer(NA),
                  away.ball.15 = as.integer(NA), home.ball.15 = as.integer(NA),
                  away.run.diff = as.integer(NA), home.run.diff = as.integer(NA)
                  )
mlb <- mlb %>%
  filter(season>=2014,season!=2020,playoff=="") %>%
  mutate(final=home.final-away.final,winner=if_else(final>0,1,0),
         away.team=if_else(away.team=="ANA","LAA",away.team),
         away.team=if_else(away.team=="FLA","MIA",away.team),
         away.team=if_else(away.team=="KCR","KC",away.team),
         away.team=if_else(away.team=="SDP","SD",away.team),
         away.team=if_else(away.team=="SFG","SF",away.team),
         away.team=if_else(away.team=="TBD","TB",away.team),
         away.team=if_else(away.team=="WSN","WAS",away.team),
         home.team=if_else(home.team=="ANA","LAA",home.team),
         home.team=if_else(home.team=="FLA","MIA",home.team),
         home.team=if_else(home.team=="KCR","KC",home.team),
         home.team=if_else(home.team=="SDP","SD",home.team),
         home.team=if_else(home.team=="SFG","SF",home.team),
         home.team=if_else(home.team=="TBD","TB",home.team),
         home.team=if_else(home.team=="WSN","WAS",home.team))
mlb$date[which(mlb$date=="2019-09-06" & mlb$away.team=="OAK")] = as.Date("2019-05-19")
mlb <- mlb[order(nrow(mlb):1),]
#mlb <- arrange(mlb,date)
mlb$game.id <- seq(1,nrow(mlb))
mlb$month <- format(mlb$date,"%m")
mlb$day <- as.factor(wday(mlb$date))

div <- data.frame(al.east=c("BAL","BOS","NYY","TB","TOR"),al.central=c("CHW","CLE","DET","KC","MIN"),al.west=c("HOU","LAA","OAK","SEA","TEX"),nl.east=c("ATL","MIA","NYM","PHI","WAS"),nl.central=c("CHC","CIN","MIL","PIT","STL"),nl.west=c("ARI","COL","LAD","SD","SF"))
mlb.teams <- c("ARI","ATL","BAL","BOS","CHC","CHW","CIN","CLE","COL","DET","HOU","KC","LAA","LAD","MIA","MIL","MIN","NYM","NYY","OAK","PHI","PIT","SD","SEA","SF","STL","TB","TEX","TOR","WAS")

mlb$stadium <- mlb$home.team
mlb <- mlb %>%
  mutate(stadium = replace(stadium,season>2016&stadium=="ATL","ATL2"),
         stadium = replace(stadium,season>2019&stadium=="TEX","TEX2"),
         stadium = replace(stadium,season==2021&date<"2021-06-01"&stadium=="TOR","TOR2"),
         stadium = replace(stadium,season==2021&date>="2021-06-01"&date<"2021-07-30"&stadium=="TOR","TOR3"),
         away.div = if_else(away.team %in% div$al.east,"AL East",if_else(away.team %in% div$al.central,"AL Central",if_else(away.team %in% div$al.west,"AL West",if_else(away.team %in% div$nl.east,"NL East",if_else(away.team %in% div$nl.central,"NL Central","NL West"))))),
         home.div = if_else(home.team %in% div$al.east,"AL East",if_else(home.team %in% div$al.central,"AL Central",if_else(home.team %in% div$al.west,"AL West",if_else(home.team %in% div$nl.east,"NL East",if_else(home.team %in% div$nl.central,"NL Central","NL West"))))),
         div.match = if_else(away.div==home.div,1,0))
# mlb$stadium[mlb$home.team=="ATL"&mlb$date=="2016-7-3"] <- "BRA"
# mlb$stadium[mlb$home.team=="PIT"&mlb$date=="2017-8-20" | mlb$home.team=="PHI"&mlb$date=="2018-8-19" | mlb$home.team=="PIT"&mlb$date=="2019-8-18"] <- "WIL"
# mlb$stadium[mlb$home.team=="HOU"&mlb$date=="2017-8-29" | mlb$home.team=="HOU"&mlb$date=="2017-8-30" | mlb$home.team=="HOU"&mlb$date=="2017-8-31"] <- "TB"
# mlb$stadium[mlb$home.team=="TB"&mlb$date=="2017-9-11" | mlb$home.team=="TB"&mlb$date=="2017-9-12" | mlb$home.team=="TB"&mlb$date=="2017-9-13"] <- "NYM"
# mlb$stadium[mlb$home.team=="MIN"&mlb$date=="2018-4-17" | mlb$home.team=="MIN"&mlb$date=="2018-4-18"] <- "PR"
# mlb$stadium[mlb$home.team=="SD"&mlb$date=="2018-5-4" | mlb$home.team=="SD"&mlb$date=="2018-5-5" | mlb$home.team=="SD"&mlb$date=="2018-5-6" | mlb$home.team=="CIN"&mlb$date=="2019-4-13" | mlb$home.team=="CIN"&mlb$date=="2019-4-14" | mlb$home.team=="LAA"&mlb$date=="2019-5-4" | mlb$home.team=="LAA"&mlb$date=="2019-5-5"] <- "MTY"
mlb$stadium[mlb$home.team=="OAK"&mlb$date=="2019-3-20" | mlb$home.team=="OAK"&mlb$date=="2019-3-21"] <- "TOK"
# mlb$stadium[mlb$home.team=="KC"&mlb$date=="2019-6-13"] <- "OMA"
mlb$stadium[mlb$home.team=="BOS"&mlb$date=="2019-6-29" | mlb$home.team=="BOS"&mlb$date=="2019-6-30"] <- "LON"

w <- vector()
x <- vector()
for(i in c(1:30)){
  temp <- filter(mlb, home.team == mlb.teams[i])
  w <- temp$away.final
  x <- temp$home.final
  for(j in c(1:nrow(temp))){
    num <- temp$game.id[j]
    if(j>16){
      mlb$away.ball.15[num] <- mean(w[c((j-15):(j-1))])
      mlb$home.ball.15[num] <- mean(x[c((j-15):(j-1))])
    }
    else{
      mlb$away.ball.15[num] <- mean(w[c(1:(j-1))])
      mlb$home.ball.15[num] <- mean(x[c(1:(j-1))])
    }
  }
}

z <- vector()
for(i in c(1:30)){
  temp <- filter(mlb, away.team == mlb.teams[i] | home.team == mlb.teams[i])
  for(j in c(1:nrow(temp))){
    if(temp$away.team[j] == mlb.teams[i])
      z[j] <- temp$away.final[j]
    if(temp$home.team[j] == mlb.teams[i])
      z[j] <- temp$home.final[j]
  }
  z <- as.integer(z)
  for(j in c(1:nrow(temp))){
    if(temp$away.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      if(j>61)
        mlb$away.60[num] <- mean(z[c((j-60):(j-1))])
      else
        mlb$away.60[num] <- mean(z[c(1:j)])
    }
    if(temp$home.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      if(j>61)
        mlb$home.60[num] <- mean(z[c((j-60):(j-1))])
      else
        mlb$home.60[num] <- mean(z[c(1:j)])
    }
  }
}

y <- vector()
for(i in c(1:30)){
  temp <- mlb %>%
    filter(away.team == mlb.teams[i] | home.team == mlb.teams[i]) %>%
    mutate(final=if_else(away.team == mlb.teams[i],-final,final))
  y <- temp$final
  y <- as.integer(y)
  for(j in c(1:nrow(temp))){
    if(temp$away.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      if(j>31)
        mlb$away.run.diff[num] <- mean(y[c((j-30):(j-1))])
      else
        mlb$away.run.diff[num] <- mean(y[c(1:j)])
    }
    if(temp$home.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      if(j>31)
        mlb$home.run.diff[num] <- mean(y[c((j-30):(j-1))])
      else
        mlb$home.run.diff[num] <- mean(y[c(1:j)])
    }
  }
}
mlb <- filter(mlb,season!=2014)
mlb$game.id <- seq(1,nrow(mlb))

for(i in c(1:30)){
  temp <- filter(mlb, away.team == mlb.teams[i] | home.team == mlb.teams[i])
  for(j in c(1:nrow(temp))){
    num <- temp$game.id[j]
    mlb$doublehead[num] <- nrow(with(temp,temp[date==temp$date[j],]))-1
  }
}

for(i in c(1:30)){
  temp <- filter(mlb, away.team == mlb.teams[i] | home.team == mlb.teams[i])
  for(j in c(1:nrow(temp))){
    if(temp$away.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      mlb$away.yest[num] <- nrow(with(temp,temp[date==temp$date[j]-1,]))
    }
    if(temp$home.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      mlb$home.yest[num] <- nrow(with(temp,temp[date==temp$date[j]-1,]))
    }
  }
}

for(i in c(1:30)){
  temp <- filter(mlb, away.team == mlb.teams[i] | home.team == mlb.teams[i])
  for(j in c(2015:2019,2021)){
    temp2 <- filter(temp,season==j)
    for(k in c(1:nrow(temp2))){
      if(temp2$away.team[k] == mlb.teams[i]){
        num <- temp2$game.id[k]
        mlb$away.game.num[num] <- k
      }
      if(temp2$home.team[k] == mlb.teams[i]){
        num <- temp2$game.id[k]
        mlb$home.game.num[num] <- k
      }
    }
  }
}

loc <- data.frame(matrix(ncol = 3, nrow = 41))
x <- c("stadium", "long","lat")
colnames(loc) <- x
loc$stadium <- c("ARI","ATL","ATL2","BAL","BOS","CHC","CHW","CIN","CLE","COL","DET","HOU","KC","LAA","LAD","MIA","MIL","MIN","NYM","NYY","OAK","PHI","PIT","SD","SEA","SF","STL","TB","TEX","TEX2","TOR","TOR2","TOR3","WAS","BRA","WIL","PR","MTY","TOK","OMA","LON")
loc$long <- c(-112.0675133,-84.3899584,-84.4689525,-76.6227698,-71.0981172,-87.6558899,-87.6346931,-84.5071904,-81.6858458,-104.994519,-83.0493191,-95.3564899,-94.4808422,-117.8834119,-118.2407581,-80.2203884,-87.9719091,-93.2790431,-73.8466345,-73.9268563,-122.2017169,-75.1679395,-80.006358,-117.1577153,-122.3327673,-122.3899435,-90.1932964,-82.654493,-97.0849471,-97.0849471,-79.3901937,-82.7870177,-78.874097,-77.0082772,-79.0020984,-77.0475079,-66.0731198,-100.315685,139.7517429,-95.9319287,-0.0170222)
loc$lat <- c(33.4454785,33.735351,33.8906143,39.2838665,42.346505,41.9480672,41.829766,39.0972264,41.4959954,39.7560699,42.3390523,29.7567234,39.0515473,33.8002162,34.0737398,25.7780448,43.0280242,44.9818611,40.7569966,40.8296535,37.7514898,39.9058291,40.4467673,32.7073764,47.5913747,37.7785116,38.6225764,27.7682258,32.7470521,32.7470521,43.6416568,28.0036856,42.880104,38.8727804,35.1635478,41.2425317,18.4166094,25.7180757,35.7056978,41.2669736,51.5386541)
for(i in c(1:30)){
  temp <- mlb %>%
    filter(away.team == mlb.teams[i] | home.team == mlb.teams[i]) %>%
    arrange(desc(game.id))
  for(j in c(1:nrow(temp))){
    if(temp$away.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      if(j!=nrow(temp)){
        prev.loc <- with(loc,loc[stadium==temp$stadium[j+1],])
        curr.loc <- with(loc,loc[stadium==temp$stadium[j],])
        mlb$away.travel[num] <- distm(c(prev.loc$long,prev.loc$lat),c(curr.loc$long,curr.loc$lat))/1000
      }
      else{
        prev.loc <- with(loc,loc[stadium==mlb.teams[i],])
        curr.loc <- with(loc,loc[stadium==temp$stadium[j],])
        mlb$away.travel[num] <- distm(c(prev.loc$long,prev.loc$lat),c(curr.loc$long,curr.loc$lat))/1000
      }
    }
    if(temp$home.team[j] == mlb.teams[i]){
      num <- temp$game.id[j]
      if(j!=nrow(temp)){
        prev.loc <- with(loc,loc[stadium==temp$stadium[j+1],])
        curr.loc <- with(loc,loc[stadium==temp$stadium[j],])
        mlb$home.travel[num] <- distm(c(prev.loc$long,prev.loc$lat),c(curr.loc$long,curr.loc$lat))/1000
      }
      else{
        prev.loc <- with(loc,loc[stadium==mlb.teams[i],])
        curr.loc <- with(loc,loc[stadium==temp$stadium[j],])
        mlb$home.travel[num] <- distm(c(prev.loc$long,prev.loc$lat),c(curr.loc$long,curr.loc$lat))/1000
      }
    }
  }
}

mlb <- mutate(mlb,away.yest=as.factor(away.yest),home.yest=as.factor(home.yest))
mlb$total <- mlb$away.final + mlb$home.final
mlb$season <- as.factor(mlb$season)

today.mlb <- filter(mlb,date==Sys.Date())
mlb <- filter(mlb,date<Sys.Date())

#today.mlb <- today.mlb[order(nrow(today.mlb):1),]
today.mlb <- today.mlb %>%
  group_by(date,away.team,game.num) %>%
  mutate(game.num = game.num + seq(0, by=1, length.out=n()))
```

ML/Spread regression models
```{r}
mlb.model <- mlb
mlb.model <- filter(mlb.model,!(season==2021&doublehead==1),stadium!="TOK",stadium!="LON",away.travel<5000,home.travel<5000)
#mlb.tot.model <- mlb2
#mlb.tot.model$total <- mlb.tot.model$away.final + mlb.tot.model$home.final

c4 <- lm(final~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest,mlb.model)
summary(c4)
n <- predict(c4, mlb.model)
mlb.model$c4 <- n
mlb.model$c4res <- lm(c4)$residuals
ggplot(mlb.model, aes(c4res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c4res,final)) +
#  geom_point()
x <- filter(mlb.model,month=="04")
sd(x$c4res)
x <- filter(mlb.model,month=="05")
sd(x$c4res)
x <- filter(mlb.model,month=="06")
sd(x$c4res)
x <- filter(mlb.model,month=="07")
sd(x$c4res)
x <- filter(mlb.model,month=="08")
sd(x$c4res)
x <- filter(mlb.model,month=="09")
sd(x$c4res)
sd(mlb.model$c4res)


c7 <- lm(final~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest+day+div.match+away.run.diff+home.run.diff,mlb.model)
summary(c7)
n <- predict(c7, mlb.model)
mlb.model$c7 <- n
mlb.model$c7res <- lm(c7)$residuals
ggplot(mlb.model, aes(c7res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c7res,final)) +
#  geom_point()
x <- filter(mlb.model,away.game.num<30)
sd(x$c7res)
sd(mlb.model$c7res)

# c6 <- lm(final~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest+away.ball.30+home.ball.30+away.15+home.15,mlb.model)
# summary(c6)
# n <- predict(c6, mlb.model)
# mlb.model$c6 <- n
# mlb.model$c6res <- lm(c6)$residuals
# ggplot(mlb.model, aes(c6res)) +
#   geom_histogram(binwidth = 1)
# #ggplot(mlb.model, aes(c4res,final)) +
# #  geom_point()
# x <- filter(mlb.model,away.game.num<30)
# sd(x$c6res)
# sd(mlb.model$c6res)

ggplot(mlb.model, aes(final)) +
  geom_histogram(binwidth = 1)


f3 <- lm(away.final~away.rate+home.rate+stadium+home.pit.adj+away.travel+home.travel+away.ball.15+home.ball.15+away.60+home.60+month+div.match,mlb.model)
summary(f3)
n <- predict(f3, mlb.model)
mlb.model$f3 <- n
g3 <- lm(home.final~away.rate+home.rate+stadium+away.pit.adj+away.travel+home.travel+away.ball.15+home.ball.15+away.60+home.60+month+div.match,mlb.model)
summary(g3)
o <- predict(g3, mlb.model)
mlb.model$g3 <- o
mlb.model$e7 <- mlb.model$f3 + mlb.model$g3
mlb.model$e7res <- mlb.model$total - mlb.model$e7
ggplot(mlb.model, aes(e7res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(e7res,total)) +
#  geom_point()
summary(mlb.model$e7)
x <- filter(mlb.model,month=="04")
sd(x$e7res)
x <- filter(mlb.model,month=="05")
sd(x$e7res)
x <- filter(mlb.model,month=="06")
sd(x$e7res)
x <- filter(mlb.model,month=="07")
sd(x$e7res)
x <- filter(mlb.model,month=="08")
sd(x$e7res)
x <- filter(mlb.model,month=="09")
sd(x$e7res)
sd(mlb.model$e7res)

f4 <- lm(away.final~away.rate+home.rate+stadium+home.pit.adj+away.travel+home.travel+away.ball.15+home.ball.15+away.60+home.60+month+div.match+season,mlb.model)
summary(f4)
n <- predict(f4, mlb.model)
mlb.model$f4 <- n
g4 <- lm(home.final~away.rate+home.rate+stadium+away.pit.adj+away.travel+home.travel+away.ball.15+home.ball.15+away.60+home.60+month+div.match+season,mlb.model)
summary(g4)
o <- predict(g4, mlb.model)
mlb.model$g4 <- o
mlb.model$e8 <- mlb.model$f4 + mlb.model$g4
mlb.model$e8res <- mlb.model$total - mlb.model$e8
ggplot(mlb.model, aes(e8res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(e8res,total)) +
#  geom_point()
summary(mlb.model$e8)
sd(mlb.model$e8res)

#plot(c4)
#ggplot(mlb.model, aes(final,away.travel)) +
#  geom_point()
#mlb.model$leverage <- hatvalues(c4)
```

Odds table
```{r}
odds <- gsheet2tbl('https://docs.google.com/spreadsheets/d/143Aby1tCInoZkhCJ121oSKoEffjENidXcbYpmAI6Mpc/edit#gid=408469873?usp=sharing')
today.odds <- data.frame(date = as.Date(odds$Date[c(TRUE, FALSE)]), game.num = odds$G[c(TRUE, FALSE)],
                         away.team = odds$Teams[c(TRUE, FALSE)], home.team = odds$Teams[c(FALSE, TRUE)],
                         away.spr = odds$Spr[c(TRUE, FALSE)], home.spr = odds$Spr[c(FALSE, TRUE)],
                         away.odds = odds$Odds[c(TRUE, FALSE)], home.odds = odds$Odds[c(FALSE, TRUE)],
                         away.ml.imp = as.numeric(sub("%","",odds$ML.Imp[c(TRUE, FALSE)]))/100, 
                         home.ml.imp = as.numeric(sub("%","",odds$ML.Imp[c(FALSE, TRUE)]))/100,
                         away.ml = odds$ML[c(TRUE, FALSE)], home.ml = odds$ML[c(FALSE, TRUE)],
                         away.spr.imp = as.numeric(sub("%","",odds$Spr.Imp[c(TRUE, FALSE)]))/100, 
                         home.spr.imp = as.numeric(sub("%","",odds$Spr.Imp[c(FALSE, TRUE)]))/100,
                         runs = odds$OU[c(TRUE, FALSE)],
                         over = odds$OU.Odds[c(TRUE, FALSE)], under = odds$OU.Odds[c(FALSE, TRUE)],
                         over.imp = as.numeric(sub("%","",odds$OU.Imp[c(TRUE, FALSE)]))/100, 
                         under.imp = as.numeric(sub("%","",odds$OU.Imp[c(FALSE, TRUE)]))/100)
today.odds <- filter(today.odds,date==Sys.Date())
today.games <- merge(today.odds,today.mlb)
today.games <- today.games %>%
  mutate(z=if_else(is.na(away.pit.adj),"*",""),
         away.pit.adj=replace(away.pit.adj,is.na(away.pit.adj),0),
         home.pit.adj=replace(home.pit.adj,is.na(home.pit.adj),0))
sd4 <- sd(mlb.model$c4res)
sd3 <- sd(mlb.model$e7res) ###################
today.games$pred.final <- suppressWarnings(predict(c4,today.games))
today.games$away.run <- suppressWarnings(predict(f3,today.games)) ###################
today.games$home.run <- suppressWarnings(predict(g3,today.games)) ###################
today.games$pred.run <- today.games$away.run + today.games$home.run

cat("Predicted betting lines\n")
today.games %>%
  arrange(game.id) %>%
  mutate(away.prob=pnorm(-pred.final/sd4)-.022,home.prob=pnorm(pred.final/sd4)+.022,
         away.imp=if_else(away.prob<.5,round(100/away.prob-100,0),round(-away.prob*100/(1-away.prob),0)),
         home.imp=if_else(home.prob<.5,round(100/home.prob-100,0),round(-home.prob*100/(1-home.prob),0)),
         o=if_else(runs<=6.5,pnorm((pred.run-runs)/sd3)-.022,
                   if_else(runs==7.0,pnorm((pred.run-runs)/sd3)-.026,
                   if_else(runs==7.5,pnorm((pred.run-runs)/sd3)-.045,
                   if_else(runs==8.0,pnorm((pred.run-runs)/sd3)-.037,
                   if_else(runs==8.5,pnorm((pred.run-runs)/sd3)-.048,
                   if_else(runs==9.0,pnorm((pred.run-runs)/sd3)-.063,
                   if_else(runs==9.5,pnorm((pred.run-runs)/sd3)-.059,
                   if_else(runs==10.0,pnorm((pred.run-runs)/sd3)-.065,
                           pnorm((pred.run-runs)/sd3)-.055)))))))),
         u=if_else(runs<=6.5,pnorm(-(pred.run-runs)/sd3)+.022,
                   if_else(runs==7.0,pnorm(-(pred.run-runs)/sd3)+.026,
                   if_else(runs==7.5,pnorm(-(pred.run-runs)/sd3)+.045,
                   if_else(runs==8.0,pnorm(-(pred.run-runs)/sd3)+.037,
                   if_else(runs==8.5,pnorm(-(pred.run-runs)/sd3)+.048,
                   if_else(runs==9.0,pnorm(-(pred.run-runs)/sd3)+.063,
                   if_else(runs==9.5,pnorm(-(pred.run-runs)/sd3)+.059,
                   if_else(runs==10.0,pnorm(-(pred.run-runs)/sd3)+.065,
                           pnorm(-(pred.run-runs)/sd3)+.055)))))))),
         over=if_else(o<.5,round(100/o-100,0),round(-o*100/(1-o),0)),
         under=if_else(u<.5,round(100/u-100,0),round(-u*100/(1-u),0)),
         away.neg=pnorm(-(pred.final+1.5)/sd4)-.009,
         away.pos=if_else(pred.run<8.5,pnorm(-(pred.final-1.5)/sd4)+.035,pnorm(-(pred.final-1.5)/sd4)+.013),
         home.neg=if_else(pred.run<8.5,pnorm((pred.final-1.5)/sd4)-.035,pnorm((pred.final-1.5)/sd4)-.013),
         home.pos=pnorm((pred.final+1.5)/sd4)+.009,
         away1.5=if_else(away.spr<0,
                         if_else(away.neg<.5,round(100/away.neg-100,0),round(-away.neg*100/(1-away.neg),0)),
                         if_else(away.pos<.5,round(100/away.pos-100,0),round(-away.pos*100/(1-away.pos),0))),
         home1.5=if_else(home.spr>0,
                         if_else(home.pos<.5,round(100/home.pos-100,0),round(-home.pos*100/(1-home.pos),0)),
                         if_else(home.neg<.5,round(100/home.neg-100,0),round(-home.neg*100/(1-home.neg),0))),
         a="|",b="|",c="|") %>%
  select(away=away.team,home=home.team,pred.final,z,a,away1.5,home1.5,b,runs,over,under,c,away.imp,home.imp)
cat("Current betting lines with better than predicted value\n")
today.games %>%
  arrange(game.id) %>%
  mutate(away.prob=pnorm(-pred.final/sd4)-.022,home.prob=pnorm(pred.final/sd4)+.022,
         away.imp=if_else(away.prob<.5,round(100/away.prob-100,0),round(-away.prob*100/(1-away.prob),0)),
         home.imp=if_else(home.prob<.5,round(100/home.prob-100,0),round(-home.prob*100/(1-home.prob),0)),
         away.ml=if_else(away.ml>away.imp,away.ml,0),home.ml=if_else(home.ml>home.imp,home.ml,0),
         o=if_else(runs<=6.5,pnorm((pred.run-runs)/sd3)-.022,
                   if_else(runs==7.0,pnorm((pred.run-runs)/sd3)-.026,
                   if_else(runs==7.5,pnorm((pred.run-runs)/sd3)-.045,
                   if_else(runs==8.0,pnorm((pred.run-runs)/sd3)-.037,
                   if_else(runs==8.5,pnorm((pred.run-runs)/sd3)-.048,
                   if_else(runs==9.0,pnorm((pred.run-runs)/sd3)-.063,
                   if_else(runs==9.5,pnorm((pred.run-runs)/sd3)-.059,
                   if_else(runs==10.0,pnorm((pred.run-runs)/sd3)-.065,
                           pnorm((pred.run-runs)/sd3)-.055)))))))),
         u=if_else(runs<=6.5,pnorm(-(pred.run-runs)/sd3)+.022,
                   if_else(runs==7.0,pnorm(-(pred.run-runs)/sd3)+.026,
                   if_else(runs==7.5,pnorm(-(pred.run-runs)/sd3)+.045,
                   if_else(runs==8.0,pnorm(-(pred.run-runs)/sd3)+.037,
                   if_else(runs==8.5,pnorm(-(pred.run-runs)/sd3)+.048,
                   if_else(runs==9.0,pnorm(-(pred.run-runs)/sd3)+.063,
                   if_else(runs==9.5,pnorm(-(pred.run-runs)/sd3)+.059,
                   if_else(runs==10.0,pnorm(-(pred.run-runs)/sd3)+.065,
                           pnorm(-(pred.run-runs)/sd3)+.055)))))))),
         o=if_else(o<.5,round(100/o-100,0),round(-o*100/(1-o),0)),
         u=if_else(u<.5,round(100/u-100,0),round(-u*100/(1-u),0)),
         over=if_else(over>o,over,0),under=if_else(under>u,under,0),
         away.neg=pnorm(-(pred.final+1.5)/sd4)-.009,
         away.pos=if_else(pred.run<8.5,pnorm(-(pred.final-1.5)/sd4)+.035,pnorm(-(pred.final-1.5)/sd4)+.013),
         home.neg=if_else(pred.run<8.5,pnorm((pred.final-1.5)/sd4)-.035,pnorm((pred.final-1.5)/sd4)-.013),
         home.pos=pnorm((pred.final+1.5)/sd4)+.009,
         away1.5=if_else(away.spr<0,
                         if_else(away.neg<.5,round(100/away.neg-100,0),round(-away.neg*100/(1-away.neg),0)),
                         if_else(away.pos<.5,round(100/away.pos-100,0),round(-away.pos*100/(1-away.pos),0))),
         home1.5=if_else(home.spr>0,
                         if_else(home.pos<.5,round(100/home.pos-100,0),round(-home.pos*100/(1-home.pos),0)),
                         if_else(home.neg<.5,round(100/home.neg-100,0),round(-home.neg*100/(1-home.neg),0))),
         away.odds=if_else(away.odds>away1.5,away.odds,0),home.odds=if_else(home.odds>home1.5,home.odds,0),
         a="|",b="|",c="|") %>%
  select(away=away.team,home=home.team,pred.final,z,a,away.odds,home.odds,b,runs,over,under,c,away.ml,home.ml)
```

Calibrating prediction accuracy
```{r}
MLplot <- function(combo){
  x <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  p <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  n <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  s <- c(c("0.29-0.32","0.32-0.35","0.35-0.38","0.38-0.41","0.41-0.44","0.44-0.47","0.47-0.5","0.5-0.53","0.53-0.56","0.56-0.59","0.62-0.65","0.65-0.68","0.68-0.71","0.68-0.71","0.71-0.74","0.74-0.77"))
  h <- data.frame(x,p,n,s)
  for(i in c(1:16)){
    h$x[i] <- .03*i+.275
    temp <- filter(combo, home.prob > .03*(i-1)+.29, home.prob < .03*i+.29)
    h$p[i] <- nrow(filter(temp, winner == 1)) / nrow(temp)
    h$n[i] <- nrow(temp)
  }
  ggplot(h, aes(x=x, y=p, color="red")) +
    geom_point(aes(size=n)) +
    geom_text(aes(label=s,hjust=0, vjust=2)) +
    geom_abline(intercept = 0, slope = 1) +
    xlim(.25,.8) +
    ylim(.25,.8) +
    ggtitle("Predicted Home Win Probability Validation") +
    xlab("Predicted Home Win Percentage") +
    ylab("Actual Home Win Percentage")
}
SprPlotNeg <- function(combo){
  x <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  p <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  n <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  s <- c(c("0.11-0.14","0.14-0.17","0.17-0.2","0.2-0.23","0.23-0.26","0.26-0.29","0.29-0.32","0.32-0.35","0.35-0.38","0.38-0.41","0.41-0.44","0.44-0.47","0.47-0.5","0.5-0.53","0.53-0.56","0.56-0.59"))
  h <- data.frame(x,p,n,s)
  for(i in c(1:16)){
    h$x[i] <- .03*i+.095
    temp <- filter(combo, home.neg > .03*(i-1)+.11, home.neg < .03*i+.11)
    h$p[i] <- nrow(filter(temp, home.final-away.final>1.5)) / nrow(temp)
    h$n[i] <- nrow(temp)
  }
  ggplot(h, aes(x=x, y=p, color="red")) +
    geom_point(aes(size=n)) +
    geom_text(aes(label=s,hjust=0, vjust=2)) +
    geom_abline(intercept = 0, slope = 1) +
    xlim(.05,.65) +
    ylim(.05,.65) +
    ggtitle("Predicted Home Win Probability Validation") +
    xlab("Predicted Home Win Percentage") +
    ylab("Actual Home Win Percentage")
}
SprPlotPos <- function(combo){
  x <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  p <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  n <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  s <- c(c("0.38-0.41","0.41-0.44","0.44-0.47","0.47-0.5","0.5-0.53","0.53-0.56","0.56-0.59","0.62-0.65","0.65-0.68","0.68-0.71","0.68-0.71","0.71-0.74","0.74-0.77","0.77-0.8","0.8-0.83"))
  h <- data.frame(x,p,n,s)
  for(i in c(1:15)){
    h$x[i] <- .03*i+.365
    temp <- filter(combo, home.pos > .03*(i-1)+.39, home.pos < .03*i+.39)
    h$p[i] <- nrow(filter(temp, home.final-away.final>-1.5)) / nrow(temp)
    h$n[i] <- nrow(temp)
  }
  ggplot(h, aes(x=x, y=p, color="red")) +
    geom_point(aes(size=n)) +
    geom_text(aes(label=s,hjust=0, vjust=2)) +
    geom_abline(intercept = 0, slope = 1) +
    xlim(.35, .85) +
    ylim(.35, .85) +
    ggtitle("Predicted Home Win Probability Validation") +
    xlab("Predicted Home Win Percentage") +
    ylab("Actual Home Win Percentage")
}
TotalPlot <- function(combo,num){
  x <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  p <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  n <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
  s <- c(c("0.11-0.14","0.14-0.17","0.17-0.2","0.2-0.23","0.23-0.26","0.26-0.29","0.29-0.32","0.32-0.35","0.35-0.38","0.38-0.41","0.41-0.44","0.44-0.47","0.47-0.5","0.5-0.53","0.53-0.56","0.56-0.59","0.62-0.65","0.65-0.68","0.68-0.71","0.68-0.71","0.71-0.74","0.74-0.77","0.77-0.8","0.8-0.83","0.83-0.86","0.86-0.89"))
  h <- data.frame(x,p,n,s)
  for(i in c(1:26)){
    h$x[i] <- .03*i+.095
    temp <- filter(combo, o > .03*(i-1)+.11, o < .03*i+.11)
    h$p[i] <- nrow(filter(temp, home.final+away.final>num)) / nrow(temp)
    h$n[i] <- nrow(temp)
  }
  ggplot(h, aes(x=x, y=p, color="red")) +
    geom_point(aes(size=n)) +
    geom_text(aes(label=s,hjust=0, vjust=2)) +
    geom_abline(intercept = 0, slope = 1) +
    xlim(.05, .95) +
    ylim(.05, .95) +
    ggtitle("Predicted Home Win Probability Validation") +
    xlab("Predicted Home Win Percentage") +
    ylab("Actual Home Win Percentage")
}
```
```{r}
accuracy <- mlb
accuracy <- filter(accuracy,!(season==2021&doublehead==1))
accuracy$total <- accuracy$away.final + accuracy$home.final

accuracy$pred.final <- suppressWarnings(predict(c4,accuracy))
accuracy$away.run <- suppressWarnings(predict(f3,accuracy))
accuracy$home.run <- suppressWarnings(predict(g3,accuracy))
accuracy$pred.run <- accuracy$away.run + accuracy$home.run

accuracy <- accuracy %>%
  mutate(away.prob=pnorm(-pred.final/sd4)-.022,home.prob=pnorm(pred.final/sd4)+.022)
MLplot(accuracy)

accuracy <- accuracy %>%
  filter(pred.run<8.5) %>%
  mutate(away.prob=pnorm(-pred.final/sd4)-.0275,home.prob=pnorm(pred.final/sd4)+.0275,
         #o=pnorm((pred.run-runs)/sd3),u=pnorm(-(pred.run-runs)/sd3),
         away.neg=pnorm(-(pred.final+1.5)/sd4)-.009,away.pos=pnorm(-(pred.final-1.5)/sd4)+.035,
         home.neg=pnorm((pred.final-1.5)/sd4)-.035,home.pos=pnorm((pred.final+1.5)/sd4)+.009)# %>%
  #filter(away.pos<.71)
SprPlotPos(accuracy)
SprPlotNeg(accuracy)

accuracy <- accuracy %>%
  filter(pred.run>8.5) %>%
  mutate(away.prob=pnorm(-pred.final/sd4)-.0275,home.prob=pnorm(pred.final/sd4)+.0275,
         #o=pnorm((pred.run-runs)/sd3),u=pnorm(-(pred.run-runs)/sd3),
         away.neg=pnorm(-(pred.final+1.5)/sd4)-.009,away.pos=pnorm(-(pred.final-1.5)/sd4)+.013,
         home.neg=pnorm((pred.final-1.5)/sd4)-.013,home.pos=pnorm((pred.final+1.5)/sd4)+.009)# %>%
  #filter(away.pos<.71)
SprPlotPos(accuracy)
SprPlotNeg(accuracy)

SprPlotNeg(accuracy) #0.012 for > 8.5 // 0.03 for < 8.5
SprPlotPos(accuracy)

x <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
p <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
n <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
s <- c(c("0.29-0.32","0.32-0.35","0.35-0.38","0.38-0.41","0.41-0.44","0.44-0.47","0.47-0.5","0.5-0.53","0.53-0.56","0.56-0.59","0.62-0.65","0.65-0.68","0.68-0.71","0.68-0.71","0.71-0.74","0.74-0.77"))
h <- data.frame(x,p,n,s)
for(i in c(1:16)){
  h$x[i] <- .03*i+.275
  temp <- filter(accuracy, home.prob > .03*(i-1)+.29, home.prob < .03*i+.29)
  h$p[i] <- nrow(filter(temp, winner == 1)) / nrow(temp)
  h$n[i] <- nrow(temp)
}
h <- filter(h,n>1)
sum(abs(h$x-h$p)*h$n)/sum(h$n) #0.01247377 - .021 // 0.01268377 - .026
```
```{r}
accuracy <- mlb
accuracy <- filter(accuracy,!(season==2021&doublehead==1))
accuracy$total <- accuracy$away.final + accuracy$home.final

accuracy$pred.final <- suppressWarnings(predict(c4,accuracy))
accuracy$away.run <- suppressWarnings(predict(f3,accuracy))###########
accuracy$home.run <- suppressWarnings(predict(g3,accuracy))###########
accuracy$pred.run <- accuracy$away.run + accuracy$home.run
sd4 <- sd(mlb.model$c4res)
sd3 <- sd(mlb.model$e7res)###########

accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-6.5)/sd3)-.022,u=pnorm(-(pred.run-6.5)/sd3)+.022) #e6 - .026
TotalPlot(accuracy,6.5)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-7)/sd3)-.026,u=pnorm(-(pred.run-7)/sd3)+.026) %>% #e6 - .024
  filter(total!=7)
TotalPlot(accuracy,7)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-7.5)/sd3)-.045,u=pnorm(-(pred.run-7.5)/sd3)+.045) #e6 - .044
TotalPlot(accuracy,7.5)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-8)/sd3)-.037,u=pnorm(-(pred.run-8)/sd3)+.037) %>% #e6 - .035
  filter(total!=8)
TotalPlot(accuracy,8)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-8.5)/sd3)-.048,u=pnorm(-(pred.run-8.5)/sd3)+.048) #e6 - .046
TotalPlot(accuracy,8.5)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-9)/sd3)-.063,u=pnorm(-(pred.run-9)/sd3)+.063) %>% #e6 - .064
  filter(total!=9)
TotalPlot(accuracy,9)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-9.5)/sd3)-.059,u=pnorm(-(pred.run-9.5)/sd3)+.059) #e6 - .059
TotalPlot(accuracy,9.5)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-10)/sd3)-.065,u=pnorm(-(pred.run-10)/sd3)+.065) %>% #e6 -.066
  filter(total!=10)
TotalPlot(accuracy,10)
accuracy <- accuracy %>%
  mutate(o=pnorm((pred.run-10.5)/sd3)-.055,u=pnorm(-(pred.run-10.5)/sd3)+.055) #e6 - .035
TotalPlot(accuracy,10.5)

x <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
p <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
n <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA)
s <- c(c("0.11-0.14","0.14-0.17","0.17-0.2","0.2-0.23","0.23-0.26","0.26-0.29","0.29-0.32","0.32-0.35","0.35-0.38","0.38-0.41","0.41-0.44","0.44-0.47","0.47-0.5","0.5-0.53","0.53-0.56","0.56-0.59","0.62-0.65","0.65-0.68","0.68-0.71","0.68-0.71","0.71-0.74","0.74-0.77","0.77-0.8","0.8-0.83","0.83-0.86","0.86-0.89"))
h <- data.frame(x,p,n,s)
for(i in c(1:26)){
  h$x[i] <- .03*i+.095
  temp <- filter(accuracy, o > .03*(i-1)+.11, o < .03*i+.11)
  h$p[i] <- nrow(filter(temp, home.final+away.final>10.5)) / nrow(temp) ###############
  h$n[i] <- nrow(temp)
}
h <- filter(h,n>1)
sum(abs(h$x-h$p)*h$n)/sum(h$n) #0.01177583 - .066 // 0.01128862 - .064
```

Team and Overall Performances
```{r}
odds <- gsheet2tbl('https://docs.google.com/spreadsheets/d/143Aby1tCInoZkhCJ121oSKoEffjENidXcbYpmAI6Mpc/edit#gid=408469873?usp=sharing')
odds2021 <- data.frame(date = as.Date(odds$Date[c(TRUE, FALSE)]),
                         game.num = 1,
                         away.team = odds$Teams[c(TRUE, FALSE)], home.team = odds$Teams[c(FALSE, TRUE)],
                         away.spr = odds$Spr[c(TRUE, FALSE)], home.spr = odds$Spr[c(FALSE, TRUE)],
                         away.odds = odds$Odds[c(TRUE, FALSE)], home.odds = odds$Odds[c(FALSE, TRUE)],
                         away.ml.imp = as.numeric(sub("%","",odds$ML.Imp[c(TRUE, FALSE)]))/100, 
                         home.ml.imp = as.numeric(sub("%","",odds$ML.Imp[c(FALSE, TRUE)]))/100,
                         away.ml = odds$ML[c(TRUE, FALSE)], home.ml = odds$ML[c(FALSE, TRUE)],
                         away.spr.imp = as.numeric(sub("%","",odds$Spr.Imp[c(TRUE, FALSE)]))/100, 
                         home.spr.imp = as.numeric(sub("%","",odds$Spr.Imp[c(FALSE, TRUE)]))/100,
                         runs = odds$OU[c(TRUE, FALSE)],
                         over = odds$OU.Odds[c(TRUE, FALSE)], under = odds$OU.Odds[c(FALSE, TRUE)],
                         over.imp = as.numeric(sub("%","",odds$OU.Imp[c(TRUE, FALSE)]))/100, 
                         under.imp = as.numeric(sub("%","",odds$OU.Imp[c(FALSE, TRUE)]))/100)
odds2021 <- odds2021 %>%
  group_by(date,away.team,game.num) %>%
  mutate(game.num = game.num + seq(0, by=1, length.out=n()))

mlb2021 <- filter(mlb,season==2021,doublehead!=1)

games2021 <- merge(odds2021,mlb2021)
sd4 <- sd(mlb.model$c4res)
sd3 <- sd(mlb.model$e7res) #######
games2021$pred.final <- suppressWarnings(predict(c4,games2021))
games2021$away.run <- suppressWarnings(predict(f3,games2021)) #######
games2021$home.run <- suppressWarnings(predict(g3,games2021)) #######
games2021$pred.run <- games2021$away.run + games2021$home.run

games2021 <- games2021 %>%
  arrange(game.id) %>%
  mutate(away.prob=pnorm(-pred.final/sd4)-.022,home.prob=pnorm(pred.final/sd4)+.022,
         away.imp=if_else(away.prob<.5,round(100/away.prob-100,0),round(-away.prob*100/(1-away.prob),0)),
         home.imp=if_else(home.prob<.5,round(100/home.prob-100,0),round(-home.prob*100/(1-home.prob),0)),
         #away.ml=if_else(away.ml>away.imp,away.ml,0),home.ml=if_else(home.ml>home.imp,home.ml,0),
         away.ml=if_else(away.ml.imp<away.prob-.025,away.ml,0),
         home.ml=if_else(home.ml.imp<home.prob-.0,home.ml,0),
         o=if_else(runs<=6.5,pnorm((pred.run-runs)/sd3)-.022,
                   if_else(runs==7.0,pnorm((pred.run-runs)/sd3)-.026,
                   if_else(runs==7.5,pnorm((pred.run-runs)/sd3)-.045,
                   if_else(runs==8.0,pnorm((pred.run-runs)/sd3)-.037,
                   if_else(runs==8.5,pnorm((pred.run-runs)/sd3)-.048,
                   if_else(runs==9.0,pnorm((pred.run-runs)/sd3)-.063,
                   if_else(runs==9.5,pnorm((pred.run-runs)/sd3)-.059,
                   if_else(runs==10.0,pnorm((pred.run-runs)/sd3)-.065,
                           pnorm((pred.run-runs)/sd3)-.055)))))))),
         u=if_else(runs<=6.5,pnorm(-(pred.run-runs)/sd3)+.022,
                   if_else(runs==7.0,pnorm(-(pred.run-runs)/sd3)+.026,
                   if_else(runs==7.5,pnorm(-(pred.run-runs)/sd3)+.045,
                   if_else(runs==8.0,pnorm(-(pred.run-runs)/sd3)+.037,
                   if_else(runs==8.5,pnorm(-(pred.run-runs)/sd3)+.048,
                   if_else(runs==9.0,pnorm(-(pred.run-runs)/sd3)+.063,
                   if_else(runs==9.5,pnorm(-(pred.run-runs)/sd3)+.059,
                   if_else(runs==10.0,pnorm(-(pred.run-runs)/sd3)+.065,
                           pnorm(-(pred.run-runs)/sd3)+.055)))))))),
         #o=if_else(o<.5,round(100/o-100,0),round(-o*100/(1-o),0)),
         #u=if_else(u<.5,round(100/u-100,0),round(-u*100/(1-u),0)),
         #over=if_else(over>o,over,0),under=if_else(under>u,under,0),
         over=if_else(over.imp<o-.0,over,0),under=if_else(under.imp<u-.0,under,0),
         away.neg=pnorm(-(pred.final+1.5)/sd4)-.009,
         away.pos=if_else(pred.run<8.5,pnorm(-(pred.final-1.5)/sd4)+.035,pnorm(-(pred.final-1.5)/sd4)+.013),
         home.neg=if_else(pred.run<8.5,pnorm((pred.final-1.5)/sd4)-.035,pnorm((pred.final-1.5)/sd4)-.013),
         home.pos=pnorm((pred.final+1.5)/sd4)+.009,
         away1.5=if_else(away.spr<0,
                         if_else(away.neg<.5,round(100/away.neg-100,0),round(-away.neg*100/(1-away.neg),0)),
                         if_else(away.pos<.5,round(100/away.pos-100,0),round(-away.pos*100/(1-away.pos),0))),
         home1.5=if_else(home.spr>0,
                         if_else(home.pos<.5,round(100/home.pos-100,0),round(-home.pos*100/(1-home.pos),0)),
                         if_else(home.neg<.5,round(100/home.neg-100,0),round(-home.neg*100/(1-home.neg),0))),
         away.odds=if_else(away.odds>away1.5,away.odds,0),home.odds=if_else(home.odds>home1.5,home.odds,0)) #%>%
  #filter(date>Sys.Date()-30)



win <- 10
games2021 <- games2021 %>%
  mutate(away.wager=if_else(away.ml!=0,if_else(away.ml<0,-(away.ml/100)*win,win/(away.ml/100)),0),
         home.wager=if_else(home.ml!=0,if_else(home.ml<0,-(home.ml/100)*win,win/(home.ml/100)),0),
         away.winnings=if_else(away.wager==0,0,if_else(winner==0,10,-away.wager)),
         home.winnings=if_else(home.wager==0,0,if_else(winner==1,10,-home.wager)))
away.ml <- games2021 %>%
  group_by(away.team) %>%
  summarise(away.winnings=sum(away.winnings),away.wager=sum(away.wager))
home.ml <- games2021 %>%
  group_by(home.team) %>%
  summarise(home.winnings=sum(home.winnings),home.wager=sum(home.wager))
ml <- merge(away.ml,home.ml,by.x="away.team",by.y="home.team")
ml$winnings <- ml$away.winnings + ml$home.winnings
ml$wager <- ml$away.wager + ml$home.wager
ml$roi <- ml$winnings / ml$wager
data.frame(away=sum(ml$away.winnings),home=sum(ml$home.winnings),winnings=sum(ml$winnings),wager=sum(ml$wager),roi=round(sum(ml$winnings)/sum(ml$wager),4))

games2021 <- games2021 %>%
  mutate(over.wager=if_else(runs!=total,if_else(over!=0,if_else(over<0,-(over/100)*win,win/(over/100)),0),0),
         under.wager=if_else(runs!=total,if_else(under!=0,if_else(under<0,-(under/100)*win,win/(under/100)),0),0),
         over.winnings=if_else(over.wager==0,0,if_else(total>runs,10,-over.wager)),
         under.winnings=if_else(under.wager==0,0,if_else(total<runs,10,-under.wager)))
away.over <- games2021 %>%
  group_by(away.team) %>%
  summarise(winnings=sum(over.winnings),wager=sum(over.wager))
home.over <- games2021 %>%
  group_by(home.team) %>%
  summarise(winnings=sum(over.winnings),wager=sum(over.wager))
away.under <- games2021 %>%
  group_by(away.team) %>%
  summarise(winnings=sum(under.winnings),wager=sum(under.wager))
home.under <- games2021 %>%
  group_by(home.team) %>%
  summarise(winnings=sum(under.winnings),wager=sum(under.wager))
over <- data.frame(away.team=away.over$away.team,over.winnings=(away.over$winnings+home.over$winnings)/2,over.wager=(away.over$wager+home.over$wager)/2)
under <- data.frame(away.team=away.under$away.team,under.winnings=(away.under$winnings+home.under$winnings)/2,under.wager=(away.under$wager+home.under$wager)/2)
ou.team <- merge(over,under,by="away.team")
ou.team$over.roi <- ou.team$over.winnings / ou.team$over.wager
ou.team$under.roi <- ou.team$under.winnings / ou.team$under.wager
ou.team <- ou.team[c(1,2,3,6,4,5,7)]
data.frame(over=sum(ou.team$over.winnings),o.wager=sum(ou.team$over.wager),o.roi=round(sum(ou.team$over.winnings)/sum(ou.team$over.wager),4),under=sum(ou.team$under.winnings),u.wager=sum(ou.team$under.wager),u.roi=round(sum(ou.team$under.winnings)/sum(ou.team$under.wager),4))
```
a - .01 h - .015
    over  o.wager  o.roi    under  u.wager  u.roi
1 279.53 3843.856 0.0727 261.2729 3632.859 0.0719
New system no adj
      over o.wager  o.roi   under u.wager  u.roi
1 264.1261 4723.86 0.0559 256.465 4985.77 0.0514
Old system
      over o.wager o.roi   under u.wager  u.roi
1 259.0261 4624.26 0.056 218.765 4874.97 0.0449

       away     home winnings    wager    roi
1 -236.8434 390.3738 153.5304 6600.914 0.0233
      over  o.wager  o.roi    under  u.wager  u.roi
1 274.5339 4434.952 0.0619 305.2689 3992.762 0.0765

-173.0522 321.7356 148.6834 6757.176 0.022





################################################################################################################






Total Runs
```{r}
odds <- gsheet2tbl('https://docs.google.com/spreadsheets/d/143Aby1tCInoZkhCJ121oSKoEffjENidXcbYpmAI6Mpc/edit#gid=408469873?usp=sharing')
today.odds <- data.frame(date = as.Date(odds$Date[c(TRUE, FALSE)]),
                         game.num = 1,
                         away.team = odds$Teams[c(TRUE, FALSE)], home.team = odds$Teams[c(FALSE, TRUE)],
                         away.spr = odds$Spr[c(TRUE, FALSE)], home.spr = odds$Spr[c(FALSE, TRUE)],
                         away.odds = odds$Odds[c(TRUE, FALSE)], home.odds = odds$Odds[c(FALSE, TRUE)],
                         away.ml.imp = as.numeric(sub("%","",odds$Spr.Imp[c(TRUE, FALSE)]))/100, 
                         home.ml.imp = as.numeric(sub("%","",odds$Spr.Imp[c(FALSE, TRUE)]))/100,
                         away.ml = odds$ML[c(TRUE, FALSE)], home.ml = odds$ML[c(FALSE, TRUE)],
                         away.spr.imp = as.numeric(sub("%","",odds$ML.Imp[c(TRUE, FALSE)]))/100, 
                         home.spr.imp = as.numeric(sub("%","",odds$ML.Imp[c(FALSE, TRUE)]))/100,
                         runs = odds$OU[c(TRUE, FALSE)],
                         over = odds$OU.Odds[c(TRUE, FALSE)], under = odds$OU.Odds[c(FALSE, TRUE)],
                         over.imp = as.numeric(sub("%","",odds$OU.Imp[c(TRUE, FALSE)]))/100, 
                         under.imp = as.numeric(sub("%","",odds$OU.Imp[c(FALSE, TRUE)]))/100)
today.odds <- today.odds %>%
  group_by(date,away.team,game.num) %>%
  mutate(game.num = game.num + seq(0, by=1, length.out=n()))
mlb2021 <- filter(mlb,season==2021)
total.runs <- merge(today.odds,mlb2021)
total.runs$total <- total.runs$away.final + total.runs$home.final
sd4 <- sd(mlb.model$c4res)
sd3 <- sd(mlb.tot.model$e4res)
total.runs$pred.final <- suppressWarnings(predict(c4,total.runs))
total.runs$away.run <- suppressWarnings(predict(f2,total.runs))
total.runs$home.run <- suppressWarnings(predict(g2,total.runs))
total.runs$pred.run <- total.runs$away.run + total.runs$home.run
total.runs <- total.runs %>%
  arrange(game.id) %>%
  mutate(o=pnorm((pred.run-runs)/sd3),u=pnorm(-(pred.run-runs)/sd3),
         o=if_else(o<.5,round(100/o-100,0),round(-o*100/(1-o),0)),
         u=if_else(u<.5,round(100/u-100,0),round(-u*100/(1-u),0)),
         over=if_else(over>o,over,0),under=if_else(under>u,under,0)) %>%
  select(date,away.team,home.team,total,pred.run,runs,over,under)
```

Other models
```{r}
mlb.model <- mlb

c1 <- lm(final~away.rate+home.rate,mlb.model)
summary(c1)
k <- predict(c1, mlb.model)
mlb.model$c1 <- k
mlb.model$c1res <- lm(c1)$residuals
ggplot(mlb.model, aes(c1res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c1res,final)) +
#  geom_point()

c2 <- lm(final~away.rate+home.rate+away.pit.adj+home.pit.adj,mlb.model)
summary(c2)
l <- predict(c2, mlb.model)
mlb.model$c2 <- l
mlb.model$c2res <- lm(c2)$residuals
ggplot(mlb.model, aes(c2res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c2res,final)) +
#  geom_point()

c3 <- lm(final~away.rate+home.rate+away.pit.rate+home.pit.rate,mlb.model)
summary(c3)
m <- predict(c3, mlb.model)
mlb.model$c3 <- m
mlb.model$c3res <- lm(c3)$residuals
ggplot(mlb.model, aes(c3res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c3res,final)) +
#  geom_point()

c4 <- lm(final~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest,mlb.model)
summary(c4)
n <- predict(c4, mlb.model)
mlb.model$c4 <- n
mlb.model$c4res <- lm(c4)$residuals
ggplot(mlb.model, aes(c4res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c4res,final)) +
#  geom_point()

c5 <- lm(final~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest+home.team,mlb.model)
summary(c5)
o <- predict(c5, mlb.model)
mlb.model$c5 <- o
mlb.model$c5res <- lm(c5)$residuals
ggplot(mlb.model, aes(c5res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.model, aes(c5res,final)) +
#  geom_point()

#plot(c1)
#plot(c2)
#plot(c3)
#plot(c4)
sd(mlb.model$c1res)
sd(mlb.model$c2res)
sd(mlb.model$c3res)
x <- filter(mlb.model,away.game.num<30)
sd(mlb.model$c4res)
sd(x$c4res)
sd(mlb.model$c5res)
#sd6 <-filter(mlb.model,!is.na(model6))
#sd(sd6$model6)
#which.max(hatvalues(a4))
#hat <- as.data.frame(hatvalues(a6))
#filter(hat,hatvalues(a6)>.15)
ggplot(mlb.model, aes(final)) +
  geom_histogram(binwidth = 1)


mlb.tot.model <- mlb2
mlb.tot.model$total <- mlb.tot.model$away.final + mlb.tot.model$home.final

e1 <- lm(total9~away.pit.rate+home.pit.rate,mlb.tot.model)
summary(e1)
k <- predict(e1, mlb.tot.model)
mlb.tot.model$e1 <- k
mlb.tot.model$e1res <- lm(e1)$residuals
ggplot(mlb.tot.model, aes(e1res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.tot.model, aes(e1res,total)) +
#  geom_point()
summary(mlb.tot.model$e1)
sd(mlb.tot.model$e1res)

e2 <- lm(total9~away.pit.rate+home.pit.rate+doublehead+away.travel+home.travel+away.yest+home.yest,mlb.tot.model)
summary(e2)
l <- predict(e2, mlb.tot.model)
mlb.tot.model$e2 <- l
mlb.tot.model$e2res <- lm(e2)$residuals
ggplot(mlb.tot.model, aes(e2res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.tot.model, aes(e2res,total)) +
#  geom_point()
summary(mlb.tot.model$e2)
sd(mlb.tot.model$e2res)

e3 <- lm(total9~home.team+away.pit.rate+home.pit.rate+away.travel+home.travel,mlb.tot.model)
summary(e3)
m <- predict(e3, mlb.tot.model)
mlb.tot.model$e3 <- m
mlb.tot.model$e3res <- lm(e3)$residuals
ggplot(mlb.tot.model, aes(e3res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.tot.model, aes(e3res,total)) +
#  geom_point()
summary(mlb.tot.model$e3)
sd(mlb.tot.model$e3res)

e5 <- lm(total9~home.team+away.pit.rate+home.pit.rate+away.travel+home.travel+away.ball.30+home.ball.30+away.15+home.15,mlb.tot.model)
summary(e5)
p <- predict(e5, mlb.tot.model)
mlb.tot.model$e5 <- p
mlb.tot.model$e5res <- lm(e5)$residuals
ggplot(mlb.tot.model, aes(e5res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.tot.model, aes(e5res,total)) +
#  geom_point()
summary(mlb.tot.model$e5)
sd(mlb.tot.model$e5res)

f1 <- lm(away9~away.rate+home.rate+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest+home.team,mlb.tot.model)
summary(f1)
n <- predict(f1, mlb.tot.model)
mlb.tot.model$f1 <- n
g1 <- lm(home9~away.rate+home.rate+away.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest+home.team,mlb.tot.model)
summary(g1)
o <- predict(g1, mlb.tot.model)
mlb.tot.model$g1 <- o
mlb.tot.model$e4 <- mlb.tot.model$f1 + mlb.tot.model$g1
mlb.tot.model$e4res <- mlb.tot.model$total - mlb.tot.model$e4
ggplot(mlb.tot.model, aes(e4res)) +
  geom_histogram(binwidth = 1)
#ggplot(mlb.tot.model, aes(e4res,total)) +
#  geom_point()
summary(mlb.tot.model$e4)
sd(mlb.tot.model$e4res)

ggplot(mlb.tot.model, aes(total9)) +
  geom_histogram(binwidth = 1)
```

Calculate 5 & 9 inning spreads
```{r}
#https://www.retrosheet.org/gamelogs/index.html
#https://www.retrosheet.org/gamelogs/glfields.txt
games.2015 <- read.csv("./Data/gl2010_19/GL2015.csv",header = FALSE)
games.2016 <- read.csv("./Data/gl2010_19/GL2016.csv",header = FALSE)
games.2017 <- read.csv("./Data/gl2010_19/GL2017.csv",header = FALSE)
games.2018 <- read.csv("./Data/gl2010_19/GL2018.csv",header = FALSE)
games.2019 <- read.csv("./Data/gl2010_19/GL2019.csv",header = FALSE)
games.stats <- rbind(games.2015,games.2016,games.2017,games.2018,games.2019)
games.stats <- games.stats %>%
  rename(date=V1,doublehead=V2, #0-1 game, 1-game 1,2-game 2
         day.of.week=V3, #"Sun","Mon","Tue","Wed","Thu","Fri","Sat"
         away.team=V4,away.league=V5,away.game.num=V6,home.team=V7,home.league=V8,home.game.num=V9,
         away.final=V10,home.final=V11,outs=V12,day.night=V13, #"D" or "N"
         incomplete=V14, #"yyyymmdd,park,vs,hs,len" len-outs at time of interruption
         forfeit=V15, #"V", "H", "T"-the game was ruled a no-decision
         protest=V16, #"P"-unidentified,"V"- fail visiting,"H"-fail home,"X"-upheld away,"Y"-upheld home
         park=V17,attendance=V18,game.time=V19,away.inn=V20,home.inn=V21,
         away.abs=V22,away.hits=V23,away.2b=V24,away.3b=V25,away.hr=V26,away.rbi=V27,
         away.sac.hits=V28,away.sac.flies=V29,away.hbp=V30,away.bb=V31,away.ibb=V32,away.k=V33,
         away.sb=V34,away.sb.caught=V35,away.off.2play=V36,away.catcher.int=V37,away.left.on.base=V38,
         away.pitchers=V39,away.ind.earned.runs=V40,away.earned.runs=V41,away.wild.pitches=V42,away.balks=V43,
         away.putouts=V44,away.assists=V45,away.errors=V46,away.passed.balls=V47,
         away.def.2plays=V48,away.def.3plays=V49,
         home.abs=V50,home.hits=V51,home.2b=V52,home.3b=V53,home.hr=V54,home.rbi=V55,
         home.sac.hits=V56,home.sac.flies=V57,home.hbp=V58,home.bb=V59,home.ibb=V60,home.k=V61,
         home.sb=V62,home.sb.caught=V63,home.off.2play=V64,home.catcher.int=V65,home.left.on.base=V66,
         home.pitchers=V67,home.ind.earned.runs=V68,home.earned.runs=V69,home.wild.pitches=V70,home.balks=V71,
         home.putouts=V72,home.assists=V73,home.errors=V74,home.passed.balls=V75,
         home.def.2plays=V76,home.def.3plays=V77,
         ump.home.id=V78,ump.home=V79,ump.1b.id=V80,ump.1b=V81,ump.2b.id=V82,ump.2b=V83,ump.3b.id=V84,ump.3b=V85,
         ump.lf.id=V86,ump.lf=V87,ump.rf.id=V88,ump.rf=V89, #NA if empty (none) if empty
         away.man.id=V90,away.man=V91,home.man.id=V92,home.man=V93,
         win.pit.id=V94,win.pit=V95,lose.pit.id=V96,lose.pit=V97,save.pit.id=V98,save.pit=V99,
         win.bat.rbi.id=V100,win.bat.rbi=V101, #NA if empty (none) if empty
         away.pitcher.id=V102,away.pitcher=V103,home.pitcher.id=V104,home.pitcher=V105,
         away.bat1.id=V106,away.bat1=V107,away.bat1.pos=V108,away.bat2.id=V109,away.bat2=V110,away.bat2.pos=V111,
         away.bat3.id=V112,away.bat3=V113,away.bat3.pos=V114,away.bat4.id=V115,away.bat4=V116,away.bat4.pos=V117,
         away.bat5.id=V118,away.bat5=V119,away.bat5.pos=V120,away.bat6.id=V121,away.bat6=V122,away.bat6.pos=V123,
         away.bat7.id=V124,away.bat7=V125,away.bat7.pos=V126,away.bat8.id=V127,away.bat8=V128,away.bat8.pos=V129,
         away.bat9.id=V130,away.bat9=V131,away.bat9.pos=V132,
         home.bat1.id=V133,home.bat1=V134,home.bat1.pos=V135,home.bat2.id=V136,home.bat2=V137,home.bat2.pos=V138,
         home.bat3.id=V139,home.bat3=V140,home.bat3.pos=V141,home.bat4.id=V142,home.bat4=V143,home.bat4.pos=V144,
         home.bat5.id=V145,home.bat5=V146,home.bat5.pos=V147,home.bat6.id=V148,home.bat6=V149,home.bat6.pos=V150,
         home.bat7.id=V151,home.bat7=V152,home.bat7.pos=V153,home.bat8.id=V154,home.bat8=V155,home.bat8.pos=V156,
         home.bat9.id=V157,home.bat9=V158,home.bat9.pos=V159,
         other=V160,info=V161) %>%
  mutate(away.team=if_else(away.team=="ANA","LAA",away.team),away.team=if_else(away.team=="CHA","CHW",away.team),
         away.team=if_else(away.team=="CHN","CHC",away.team),away.team=if_else(away.team=="KCA","KC",away.team),
         away.team=if_else(away.team=="LAN","LAD",away.team),away.team=if_else(away.team=="NYA","NYY",away.team),
         away.team=if_else(away.team=="NYN","NYM",away.team),away.team=if_else(away.team=="SDN","SD",away.team),
         away.team=if_else(away.team=="SFN","SF",away.team),away.team=if_else(away.team=="SLN","STL",away.team),
         away.team=if_else(away.team=="TBA","TB",away.team),
         home.team=if_else(home.team=="ANA","LAA",home.team),home.team=if_else(home.team=="CHA","CHW",home.team),
         home.team=if_else(home.team=="CHN","CHC",home.team),home.team=if_else(home.team=="KCA","KC",home.team),
         home.team=if_else(home.team=="LAN","LAD",home.team),home.team=if_else(home.team=="NYA","NYY",home.team),
         home.team=if_else(home.team=="NYN","NYM",home.team),home.team=if_else(home.team=="SDN","SD",home.team),
         home.team=if_else(home.team=="SFN","SF",home.team),home.team=if_else(home.team=="SLN","STL",home.team),
         home.team=if_else(home.team=="TBA","TB",home.team))
```
```{r}
games.stats <- mutate(games.stats,top1=NA,top2=NA,top3=NA,top4=NA,top5=NA,top6=NA,top7=NA,top8=NA,top9=NA,
                      top10=NA,top11=NA,top12=NA,top13=NA,top14=NA,top15=NA,top16=NA,top17=NA,top18=NA,top19=NA,
                      bot1=NA,bot2=NA,bot3=NA,bot4=NA,bot5=NA,bot6=NA,bot7=NA,bot8=NA,bot9=NA,
                      bot10=NA,bot11=NA,bot12=NA,bot13=NA,bot14=NA,bot15=NA,bot16=NA,bot17=NA,bot18=NA,bot19=NA)
for(i in c(1:nrow(games.stats))){
  away.inn <- unlist(strsplit(games.stats$away.inn[i],""))
  away.para <- match("(",away.inn)
  home.inn <- unlist(strsplit(games.stats$home.inn[i],""))
  home.para <- match("(",home.inn)
  if(!is.na(away.para)){
    away.inn[away.para] <- paste(away.inn[away.para+1],away.inn[away.para+2],sep = "")
    away.inn <- away.inn[-c(away.para+1,away.para+2,away.para+3)]
  }
  if(!is.na(home.para)){
    home.inn[home.para] <- paste(home.inn[home.para+1],home.inn[home.para+2],sep = "")
    home.inn <- home.inn[-c(home.para+1,home.para+2,home.para+3)]
  }
  for(j in c(1:19)){
    games.stats[i,j+161] <- away.inn[j]
    games.stats[i,j+180] <- home.inn[j]
  }
}
games.stats <- mutate(games.stats,bot5=if_else(bot5=="x",as.character(NA),bot5),
                      bot6=if_else(bot6=="x",as.character(NA),bot6),
                      bot7=if_else(bot7=="x",as.character(NA),bot7),
                      bot8=if_else(bot8=="x",as.character(NA),bot8),
                      bot9=if_else(bot9=="x",as.character(NA),bot9))
for(i in c(1:38)){
  games.stats[,i+161] <- as.integer(games.stats[,i+161])
}
games.stats <- mutate(games.stats,
                      top5=if_else(is.na(top5),as.integer(0),top5),
                      top6=if_else(is.na(top6),as.integer(0),top6),
                      top7=if_else(is.na(top7),as.integer(0),top7),
                      top8=if_else(is.na(top8),as.integer(0),top8),
                      top9=if_else(is.na(top9),as.integer(0),top9),
                      bot5=if_else(is.na(bot5),as.integer(0),bot5),
                      bot6=if_else(is.na(bot6),as.integer(0),bot6),
                      bot7=if_else(is.na(bot7),as.integer(0),bot7),
                      bot8=if_else(is.na(bot8),as.integer(0),bot8),
                      bot9=if_else(is.na(bot9),as.integer(0),bot9),
                      away5=top1+top2+top3+top4+top5,
                      home5=bot1+bot2+bot3+bot4+bot5,
                      away9=top1+top2+top3+top4+top5+top6+top7+top8+top9,
                      home9=bot1+bot2+bot3+bot4+bot5+bot6+bot7+bot8+bot9)
games.stats$date <- ymd(games.stats$date)
fives <- games.stats[,c(1,3,4,6,7,9:11,13,200:203)]
mlb2 <- merge(mlb,fives,by=c("date","away.team","home.team","away.game.num","home.game.num","away.final","home.final"))
mlb2 <- mutate(mlb2,final5=home5-away5,winner5=if_else(final5>0,1,if_else(final5<0,0,.5)),total9=away9+home9)
```
The information used here was obtained free of
charge from and is copyrighted by Retrosheet.  Interested
parties may contact Retrosheet at "www.retrosheet.org".

5 inning regression models
```{r}
mlb.model <- mlb

d1 <- lm(final5~away.rate+home.rate,mlb.model)
summary(d1)
k <- predict(d1, mlb.model)
mlb.model$d1 <- k
mlb.model$d1res <- lm(d1)$residuals
ggplot(mlb.model, aes(d1res)) +
  geom_histogram(binwidth = 1)
ggplot(mlb.model, aes(d1res,final5)) +
  geom_point()

d2 <- lm(final5~away.rate+home.rate+away.pit.adj+home.pit.adj,mlb.model)
summary(d2)
l <- predict(d2, mlb.model)
mlb.model$d2 <- l
mlb.model$d2res <- lm(d2)$residuals
ggplot(mlb.model, aes(d2res)) +
  geom_histogram(binwidth = 1)
ggplot(mlb.model, aes(d2res,final5)) +
  geom_point()

d3 <- lm(final5~away.rate+home.rate+away.pit.rate+home.pit.rate,mlb.model)
summary(d3)
m <- predict(d3, mlb.model)
mlb.model$d3 <- m
mlb.model$d3res <- lm(d3)$residuals
ggplot(mlb.model, aes(d3res)) +
  geom_histogram(binwidth = 1)
ggplot(mlb.model, aes(d3res,final5)) +
  geom_point()

d4 <- lm(final5~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest,mlb.model)
summary(d4)
n <- predict(d4, mlb.model)
mlb.model$d4 <- n
mlb.model$d4res <- lm(d4)$residuals
ggplot(mlb.model, aes(d4res)) +
  geom_histogram(binwidth = 1)
ggplot(mlb.model, aes(d4res,final5)) +
  geom_point()

d5 <- lm(final5~away.rate+home.rate+away.pit.adj+home.pit.adj+doublehead+away.travel+home.travel+away.yest+home.yest+home.team,mlb.model)
summary(d5)
o <- predict(d5, mlb.model)
mlb.model$d5 <- o
mlb.model$d5res <- lm(d5)$residuals
ggplot(mlb.model, aes(d5res)) +
  geom_histogram(binwidth = 1)
ggplot(mlb.model, aes(d5res,final5)) +
  geom_point()

#plot(d1)
#plot(d2)
#plot(d3)
#plot(d4)
sd(mlb.model$d1res)
sd(mlb.model$d2res)
sd(mlb.model$d3res)
sd(mlb.model$d4res)
sd(mlb.model$d5res)
#sd6 <-filter(mlb.model,!is.na(model6))
#sd(sd6$model6)
#which.max(hatvalues(a4))
#hat <- as.data.frame(hatvalues(a6))
#filter(hat,hatvalues(a6)>.15)
```